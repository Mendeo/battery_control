<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Battery control</title>
</head>
<body>
	<h1>Контроль заряда телефона через Raspbery Pi</h1>
	<p>Этот сервер отвечает за включение или отключение зарядки телефона, через который раздаётся интернет. Управление осуществляется через "умный" usb провод.</p>
	<a href="/startCharge">Начать зарядку</a>
	<br>
	<a href="/stopCharge">Остановить зарядку</a>
	<br>
	<h2>Последние известные параметры</h2>
	<table id="batInfo"></table>
</body>
<script type="text/javascript">
	(function()
	{
		'use strict';
		getBatteryInfo();
		function getBatteryInfo()
		{
			const DEFAULT_PERIOD = 15000;
			fetch('/getBatteryInfo').then((res) => 
			{
				if (res.ok) return res.json();
			}).then((data) =>
			{
				const batInfoTable = document.getElementById('batInfo');
				while (batInfoTable.firstChild)
				{
					batInfoTable.firstChild.remove();
				}
				const requestTime = data.time ? new Date(data.time) : new Date();
				for (let key in data)
				{
					const row = document.createElement('tr');
					const col1 = document.createElement('td');
					const col2 = document.createElement('td');
					col1.innerText = key;
					col2.innerText = key === 'time' ? requestTime.toLocaleString('ru-RU', { hour: 'numeric', minute: 'numeric', second: 'numeric' }) : data[key];
					row.append(col1);
					row.append(col2);
					batInfoTable.append(row);
				}
				if (data.time && data.period)
				{
					const elapsed = Date.now() - requestTime.getTime();
					let when = Number(data.period) - elapsed + randomInteger(2000, 7000);
					if (when < 0) when = Number(data.period);
					setTimeout(getBatteryInfo, when)
				}
				else
				{
					setTimeout(getBatteryInfo, DEFAULT_PERIOD);
				}
			}).catch(() =>
			{
				setTimeout(getBatteryInfo, DEFAULT_PERIOD);
			});
		}
		function randomInteger(min, max)
		{
			const rand = min - 0.5 + Math.random() * (max - min + 1);
			return Math.round(rand);
		}
	})();
</script>
</html>