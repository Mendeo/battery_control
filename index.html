<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Battery control</title>
</head>
<body>
	<h1>Контроль заряда телефона через Raspbery Pi</h1>
	<p>Этот сервер отвечает за включение или отключение зарядки телефона, через который раздаётся интернет. Управление осуществляется через "умный" usb провод.</p>
	<a href="/startCharge">Начать зарядку</a>
	<br>
	<a href="/stopCharge">Остановить зарядку</a>
	<br>
	<div class="status">
		<b>Статус сервера</b>
		<br>
		<div class="status_indicator"></div>
		<span class="status_text"></span>
	</div>
	<h2>Последние известные параметры телефона</h2>
	<table id="batteryInfo"></table>
	<h2>Текущие данные от сервера</h2>
	<table id="serverInfo"></table>
</body>
<script type="text/javascript">
	(function()
	{
		'use strict';
		const showServerStatusElement = document.querySelectorAll('.status_indicator');
		const showServerStatusTextElement = document.querySelectorAll('.status_text');
		getBatteryInfo();
		function getBatteryInfo()
		{
			const DEFAULT_PERIOD = 15000;
			fetch('/getStatus').then((res) => 
			{
				if (res.ok) return res.json();
			}).then((data) =>
			{
				showServerStatusElement.forEach(element => element.classList.remove('status_not_available'));
				showServerStatusTextElement.forEach(element => element.innerText = 'Доступен');
				let whenNextRequest = DEFAULT_PERIOD;

				const batteryInfoTable = document.getElementById('batteryInfo');
				const phoneData = parseServerInfo(data.phoneData);
				if (phoneData)
				{
					if (phoneData.lastInfoTime && phoneData.period)
					{
						const lastPhoneDataTime = new Date(phoneData.lastInfoTime);
						phoneData.lastInfoTime = lastPhoneDataTime.toLocaleString('ru-RU', { hour: 'numeric', minute: 'numeric', second: 'numeric' });
						const elapsed = Date.now() - lastPhoneDataTime.getTime();
						let whenNextRequest = Number(phoneData.period) - elapsed + randomInteger(2000, 7000);
						if (whenNextRequest < 0) whenNextRequest = Number(phoneData.period);
					}
					showObjectAsTable(phoneData, batteryInfoTable);
				}
				const serverData = parseServerInfo(data.serverData);
				const serverInfoTable = document.getElementById('serverInfo');
				if (serverData)
				{
					showObjectAsTable(serverData, serverInfoTable);
				}
				setTimeout(getBatteryInfo, whenNextRequest);
			}).catch(() =>
			{
				showServerStatusElement.forEach(element => element.classList.add('status_not_available'));
				showServerStatusTextElement.forEach(element => element.innerText = 'Не доступен');
				setTimeout(getBatteryInfo, DEFAULT_PERIOD);
			});
		}
		function showObjectAsTable(obj, tableElement)
		{
			//Удаляем всю информацию из таблицы
			while (tableElement.firstChild)
			{
				tableElement.firstChild.remove();
			}
			for (let key in obj)
			{
				const row = document.createElement('tr');
				const col1 = document.createElement('td');
				const col2 = document.createElement('td');
				col1.innerText = key;
				col2.innerText = obj[key];
				row.append(col1, col2);
				tableElement.append(row);
			}
		}
		function randomInteger(min, max)
		{
			const rand = min - 0.5 + Math.random() * (max - min + 1);
			return Math.round(rand);
		}
		function parseServerInfo(base64Data)
		{
			if (base64Data)
			{
				try
				{
					return JSON.parse(atob(base64Data));
				}
				catch
				{
					return null;
				}
			}
		}
	})();
</script>
<style>
	.status_indicator
	{
		border-radius: 50%;
		width: 1rem;
		height: 1rem;
		background-color: green;
		display: inline-block;
	}
	.status_not_available
	{
		background-color: red;
	}
	.status
	{
		padding-top: 1rem;
	}
</style>
</html>